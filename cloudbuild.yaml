# cloudbuild.yaml (디렉토리 구조 반영 최종 수정본)

steps:
  # 단계 1: Docker 이미지 빌드
- name: 'gcr.io/cloud-builders/docker'
  id: 'Build'
  args:
    - 'build'
    - '-t'
    - 'us-west1-docker.pkg.dev/hyperscale-ai-442809/gnaix-aiops/fe-dev:$SHORT_SHA'
    # [수정] 빌드 경로를 '.' (현재 디렉토리)로 변경하여 실제 구조와 일치시킵니다.
    - '.'

  # 단계 2: Artifact Registry에 이미지 푸시
- name: 'gcr.io/cloud-builders/docker'
  id: 'Push'
  waitFor: ['Build']
  args:
    - 'push'
    - 'us-west1-docker.pkg.dev/hyperscale-ai-442809/gnaix-aiops/fe-dev:$SHORT_SHA'

  # 단계 3: Cloud Run에 배포
- name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
  id: 'Deploy'
  waitFor: ['Push']
  entrypoint: gcloud
  args:
    - 'run'
    - 'deploy'
    - 'gnaix-dev-aiops-fe'
    - '--image'
    - 'us-west1-docker.pkg.dev/hyperscale-ai-442809/gnaix-aiops/fe-dev:$SHORT_SHA'
    - '--region'
    - 'us-west1'
    - '--port=3000'
    - '--cpu'
    - '1'
    - '--memory'
    - '1Gi'
    - '--min-instances'
    - '0'
    - '--platform'
    - 'managed'
    - '--allow-unauthenticated'
    - '--service-account=gnaix-dev-mlops@hyperscale-ai-442809.iam.gserviceaccount.com'

options:
  logging: CLOUD_LOGGING_ONLY
